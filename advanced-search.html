<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<!-- Makes the site responsive for all device sizes -->
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>SeedVault - Advanced Search</title>

<!-- Google font -->
<link href="https://fonts.googleapis.com/css?family=Nunito+Sans:400,900&display=swap" rel="stylesheet">

<style>

  /* =======================
     GLOBAL STYLING
  ======================= */

body {
  background-color: #e1d7c6;
  margin: 0;
  font-family: 'Nunito Sans', sans-serif;
}

  /* =======================
     HEADER BAR STYLING
  ======================= */

.header {
  background: #281d05;
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.header h1 {
  color: #e1d7c6;
  margin: 0;
  font-size: 1.8rem;
}

.header a {
  color: #e1d7c6;
  text-decoration: none;
  font-weight: 600;
  padding: 0.5rem 1rem;
  background: #0f6939;
  border-radius: 0.5rem;
  transition: background 0.3s;
}

.header a:hover {
  background: #0d512d;
}

  /* =======================
     SEARCH CONTAINER
  ======================= */

.search-container {
  max-width: 1200px;
  margin: 2rem auto;
  padding: 0 2rem;
}

.search-header {
  background: #ffffff;
  border-radius: 1rem;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: 0 4px 12px rgba(40, 29, 5, 0.1);
  border: 2px solid #b1aca2;
}

.search-header h2 {
  color: #0d512d;
  margin: 0 0 0.5rem 0;
}

.search-header p {
  color: #3b2a19;
  margin: 0 0 1.5rem 0;
}

/* =======================
   MAIN SEARCH BAR
======================= */

.main-search {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.main-search input {
  flex: 1;
  padding: 1rem;
  border: 2px solid #b1aca2;
  border-radius: 0.5rem;
  background: #e1d7c6;
  font-size: 1rem;
  color: #281d05;
}

/* Highlights active typing area */
.main-search input:focus {
  outline: none;
  border-color: #0f6939;
}

.main-search button {
  padding: 1rem 2rem;
  background: #0f6939;
  color: #ffffff;
  border: none;
  border-radius: 0.5rem;
  cursor: pointer;
  font-weight: 600;
  font-size: 1rem;
}

.main-search button:hover {
  background: #0d512d;
}

/* =======================
   FILTERING CONTROLS
======================= */

.advanced-filters {
  background: #e1d7c6;
  padding: 1.5rem;
  border-radius: 0.5rem;
  margin-bottom: 1rem;
}

.filter-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.filter-group label {
  font-weight: 600;
}

.filter-group input,
.filter-group select {
  padding: 0.6rem;
  border-radius: 0.5rem;
  border: 2px solid #b1aca2;
}

/* Reset button */
.clear-btn {
  background: #865e0d;
  color: white;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 0.5rem;
  cursor: pointer;
}

.clear-btn:hover {
  background: #3b2a19;
}

/* =======================
   STATS BAR
======================= */

.stats-bar {
  background: #281d05;
  color: #e1d7c6;
  padding: 1rem;
  display: flex;
  justify-content: space-around;
  border-radius: 0.5rem;
}

.stat-value {
  color: #0f6939;
  font-weight: bold;
}

/* =======================
   SEARCH RESULTS
======================= */

.results-container {
  background: white;
  border-radius: 1rem;
  padding: 2rem;
  margin-top: 1rem;
}

.result-card {
  border: 2px solid #b1aca2;
  margin-bottom: 1rem;
  padding: 1rem;
  border-radius: 0.8rem;
  cursor: pointer;
}

.result-card:hover {
  border-color: #0f6939;
}

/* =======================
   JAVASCRIPT LOGIC
======================= */

</style>
</head>

<body>

<!-- Top Navigation -->
<div class="header">
  <h1>üå± SeedVault Advanced Search</h1>
  <a href="seed.html">‚Üê Back to Browse</a>
</div>

<div class="search-container">

  <!-- Search UI -->
  <div class="search-header">
    <h2>üîç Advanced Search Engine</h2>
    <p>Search by keyword, filter by access, type, and date</p>

    <!-- Text search input -->
    <div class="main-search">
      <input id="searchQuery" placeholder="Search titles, authors, tags..."
             onkeypress="if(event.key==='Enter') performSearch()">
      <button onclick="performSearch()">Search</button>
    </div>
    
    <!-- Filters -->
    <div class="advanced-filters">
      <h3>Advanced Filters</h3>
      <div class="filter-grid">

        <!-- Access filter -->
        <div class="filter-group">
          <label>Access Level</label>
          <select id="accessFilter">
            <option value="">All</option>
            <option value="public">Public</option>
            <option value="tribe1">Tribe 1</option>
            <option value="tribe2">Tribe 2</option>
            <option value="tribe3">Tribe 3</option>
          </select>
        </div>

        <!-- Type filter -->
        <div class="filter-group">
          <label>File Type</label>
          <select id="typeFilter">
            <option value="">All</option>
            <option value="image">Image</option>
            <option value="audio">Audio</option>
            <option value="video">Video</option>
            <option value="pdf">PDF</option>
            <option value="document">Document</option>
          </select>
        </div>

        <!-- Date filters -->
        <div class="filter-group">
          <label>Date From</label>
          <input type="date" id="dateFrom">
        </div>

        <div class="filter-group">
          <label>Date To</label>
          <input type="date" id="dateTo">
        </div>

      </div>

      <button class="clear-btn" onclick="clearFilters()">Clear Filters</button>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-bar">
    <div>Queries: <span id="queryCount">0</span></div>
    <div>Avg Latency: <span id="avgLatency">0ms</span></div>
    <div>Results: <span id="resultsCount">0</span></div>
    <div>Denied: <span id="deniedCount">0</span></div>
  </div>

  <!-- Results -->
  <div class="results-container">
    <div id="loadingState">Enter a query to begin searching</div>
    <div id="resultsArea"></div>
  </div>

</div>

<script>

/*
  Holds logged in user role for permission checking
*/
let currentRole = localStorage.getItem('role') || 'guest';

/*
  Tracks performance and activity
*/
let metrics = {
  queries: 0,
  totalLatency: 0,
  denied: 0
};

/*
  Stores files pulled from server
*/
let artifacts = [];


/*
  Determines if user can view file
*/
function canAccess(a) {
  if (currentRole === 'admin') return true;
  if (a.access_level === 'public') return true;
  return a.access_level === currentRole;
}

/*
  Performs keyword + filter search
*/
function performSearch() {
  const start = performance.now();
  metrics.queries++;

  const query = document.getElementById('searchQuery').value.toLowerCase();
  const access = document.getElementById('accessFilter').value;
  const type = document.getElementById('typeFilter').value;

  let results = artifacts.filter(a => {
    if (query && !(a.title + a.description).toLowerCase().includes(query)) return false;
    if (access && a.access_level !== access) return false;
    if (type && getType(a.mimetype) !== type) return false;
    return canAccess(a);
  });

  const time = performance.now() - start;
  metrics.totalLatency += time;

  displayResults(results, time);
  updateStats();
}

/*
  Displays results visually
*/
function displayResults(res, time) {
  document.getElementById('resultsArea').innerHTML = `
    <p>Found ${res.length} in ${time.toFixed(2)}ms</p>
    ${res.map(r => `<div class="result-card">${r.title}</div>`).join("")}
  `;
}

/*
  Updates statistics panel
*/
function updateStats() {
  document.getElementById('queryCount').textContent = metrics.queries;
  document.getElementById('avgLatency').textContent = Math.round(metrics.totalLatency / metrics.queries) + "ms";
  document.getElementById('resultsCount').textContent =
    document.querySelectorAll('.result-card').length;
}

/*
  Clears user filters
*/
function clearFilters() {
  ['searchQuery', 'accessFilter', 'typeFilter'].forEach(i =>
    document.getElementById(i).value = ''
  );
  document.getElementById('resultsArea').innerHTML = '';
}

/*
  Converts MIME type into readable label
*/
function getType(m) {
  if (!m) return 'document';
  if (m.includes('image')) return 'image';
  if (m.includes('audio')) return 'audio';
  if (m.includes('video')) return 'video';
  if (m.includes('pdf')) return 'pdf';
  return 'document';
}

/*
  Pull file records from backend API
*/
async function loadArtifacts() {
  const res = await fetch(`http://localhost:3000/api/files`);
  const data = await res.json();
  artifacts = data.files || [];
}

loadArtifacts();
</script>

</body>
</html>
