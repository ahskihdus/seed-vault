<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
<title>Seed Vault - Browse Archive</title>
<link rel="shortcut icon" href="a198cd0c_e2f0_4c99_ba51_342624a24db9_WP4_icon.ico"/>
<link href="https://fonts.googleapis.com/css?family=Nunito+Sans:400,900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/styles.css">

<style>
body { background-color: #e1d7c6; text-align: center; }
#artInput { width: 60%; padding: 12px 40px; border-radius: 25px; }
.badge-public { background:#0f6939;color:white; }
.badge-tribe1 { background:#865e0d;color:white; }
.badge-tribe2 { background:#3b2a19;color:#e1d7c6; }
.badge-tribe3 { background:#281d05;color:#e1d7c6; }
.filter-btn.active{background:#0f6939;color:white}
.stats { display:flex; justify-content:center; gap:2rem; margin:1rem; }
.stat-box{background:white;padding:1rem;border-radius:0.5rem;border:2px solid #b1aca2;}
.access-warning { background:#fff3cd;padding:1rem;margin:1rem;border:2px solid #ffc107 }
.user-info-banner { background:#0f6939;color:white;padding:0.8rem;margin-bottom:1rem;border-radius:0.5rem }
</style>
</head>

<body>

<div class="user-info-banner" id="userInfoBanner"></div>

<h1><a href="index.html">Seed Vault</a></h1>
<h2>Search artifacts by name, author, and more</h2>

<a href="advanced-search.html" class="btn btn-success mb-3">üîç Advanced Search</a>

<div class="stats">
  <div class="stat-box">Public: <span id="count-public">0</span></div>
  <div class="stat-box">Tribe 1: <span id="count-tribe1">0</span></div>
  <div class="stat-box">Tribe 2: <span id="count-tribe2">0</span></div>
  <div class="stat-box">Tribe 3: <span id="count-tribe3">0</span></div>
</div>

<div class="filter-buttons">
  <button class="filter-btn active" onclick="filterArtifacts('all', event)">All</button>
  <button class="filter-btn" onclick="filterArtifacts('public', event)">Public</button>
  <button class="filter-btn" onclick="filterArtifacts('tribe1', event)">Tribe 1</button>
  <button class="filter-btn" onclick="filterArtifacts('tribe2', event)">Tribe 2</button>
  <button class="filter-btn" onclick="filterArtifacts('tribe3', event)">Tribe 3</button>
</div>

<input type="text" id="artInput" onkeyup="searchTable()" placeholder="Search artifacts">

<div id="accessWarning" class="access-warning" style="display:none;"></div>
<div id="loadingMessage">Loading artifacts...</div>

<table id="artTable" class="table table-bordered" style="display:none;">
<thead>
<tr>
<th>Title</th><th>Uploaded By</th><th>Date</th><th>Type</th><th>Access</th>
</tr>
</thead>
<tbody id="artifactTableBody"></tbody>
</table>

<p>This project was created and is maintained by Seed Vault.</p>

<script>
let allArtifacts = [];
let currentUser = localStorage.getItem("loggedInUser") || "Guest";
let currentRole = localStorage.getItem("role") || "guest";

document.getElementById("userInfoBanner").innerText =
  `Welcome, ${currentUser} (${currentRole.toUpperCase()})`;

fetch(`http://localhost:3000/api/files?role=${currentRole}`)
.then(res => res.json())
.then(data => {
  if(data.success){
    allArtifacts = data.files.sort((a,b)=>new Date(b.upload_date||b.uploadDate)-new Date(a.upload_date||a.uploadDate));
    displayArtifacts(allArtifacts);
    document.getElementById("loadingMessage").style.display="none";
    document.getElementById("artTable").style.display="table";
    updateCounts(allArtifacts);
  } else {
    throw new Error();
  }
}).catch(()=>{
  allArtifacts = [
    {title:"Rosetta Disk",uploaded_by_name:"Long Now",upload_date:"2004-06-04",mimetype:"application/pdf",access_level:"public"},
    {title:"Basket Weaving",uploaded_by_name:"Tribe 1",upload_date:"2023-11-15",mimetype:"image/jpeg",access_level:"tribe1"},
    {title:"Ancestral Audio",uploaded_by_name:"Tribe 2",upload_date:"2024-02-20",mimetype:"audio/mpeg",access_level:"tribe2"},
    {title:"Festival Music",uploaded_by_name:"Tribe 3",upload_date:"2024-03-15",mimetype:"audio/mpeg",access_level:"tribe3"}
  ];
  displayArtifacts(allArtifacts);
  updateCounts(allArtifacts);
  document.getElementById("loadingMessage").style.display="none";
  document.getElementById("artTable").style.display="table";
});

function displayArtifacts(list){
  const tbody=document.getElementById("artifactTableBody");
  tbody.innerHTML="";
  let hidden=0;

  list.forEach(a=>{
    const access=a.access_level||"public";
    if(currentRole!=="admin" && access!=="public" && access!==currentRole){
      hidden++; return;
    }

    const row=document.createElement("tr");
    row.style.cursor="pointer";

    row.onclick=()=>location.href=`view-artifact.html?id=${a.id||a.title}`;

    const date=new Date(a.upload_date||a.uploadDate);
    const type=a.mimetype?.split("/")[0]||"file";

    row.innerHTML=`
      <td>${a.title||a.original_name||"Untitled"}</td>
      <td>${a.uploaded_by_name||"Unknown"}</td>
      <td>${date.toLocaleDateString()}</td>
      <td>${type}</td>
      <td><span class="badge badge-${access}">${access}</span></td>
    `;
    tbody.appendChild(row);
  });

  document.getElementById("accessWarning").style.display = hidden>0?"block":"none";
  document.getElementById("accessWarning").innerText =
    hidden>0?`‚ö†Ô∏è ${hidden} artifacts hidden due to access level`:"";
}

function filterArtifacts(level,e){
document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
e.target.classList.add("active");
displayArtifacts(level==="all"?allArtifacts:allArtifacts.filter(a=>a.access_level===level));
}

function searchTable(){
const q=artInput.value.toUpperCase();
const rows=document.querySelectorAll("#artifactTableBody tr");
let show=0;
rows.forEach(r=>{
  const match=r.innerText.toUpperCase().includes(q);
  r.style.display=match?"":"none";
  if(match) show++;
});
if(show===0) document.getElementById("accessWarning").innerText="No results.";
}

function updateCounts(list){
const counts={public:0,tribe1:0,tribe2:0,tribe3:0};
list.forEach(a=>counts[a.access_level]++);
for(let k in counts){
  document.getElementById("count-"+k).innerText=counts[k];
}
}
</script>

</body>
</html>
